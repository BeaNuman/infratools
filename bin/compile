#!/usr/bin/env bash

BUILD_DIR=$PWD
ENV_DIR=$PWD/env

BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

mkdir -p "$BUILD_DIR/.profile.d"

cp "$BP_DIR"/scripts/fetch_vault_credentials.sh "$BUILD_DIR/.profile.d/"
cp "$BP_DIR"/scripts/fetch_vault_credentials.py "$BUILD_DIR/.profile.d/"

cat >"$BP_DIR/export" <<EOL
acceptlist_regex=''
denylist_regex='^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'
if [ -d "$ENV_DIR" ]; then
for e in \$(ls $ENV_DIR); do
    echo \$e
    echo "\$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
    export "\$e=\$(cat $ENV_DIR/\$e)"
    :
done
fi

export VAULT_ADDRESS=\$(cat $ENV_DIR/VAULT_ADDRESS)
export VAULT_KV_STORE=\$(cat $ENV_DIR/VAULT_KV_STORE)
export VAULT_NAMESPACE=\$(cat $ENV_DIR/VAULT_NAMESPACE)
export VAULT_ROLE_ID=\$(cat $ENV_DIR/VAULT_ROLE_ID)
export VAULT_ROLE_NAMESPACE=\$(cat $ENV_DIR/VAULT_ROLE_NAMESPACE)
export VAULT_ROLE_SECRET=\$(cat $ENV_DIR/VAULT_ROLE_SECRET)
export VAULT_SECRET=\$(cat $ENV_DIR/VAULT_SECRET)

cd ${BUILD_DIR}/.profile.d/
./fetch_vault_credentials.sh
cd -
EOL
